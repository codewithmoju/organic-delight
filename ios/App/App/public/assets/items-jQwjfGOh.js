var t=Object.defineProperty,e=Object.defineProperties,a=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,r=(e,a,n)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[a]=n,d=(t,e)=>{for(var a in e||(e={}))o.call(e,a)&&r(t,a,e[a]);if(n)for(var a of n(e))i.call(e,a)&&r(t,a,e[a]);return t},s=(t,n)=>e(t,a(n)),c=(t,e,a)=>new Promise((n,o)=>{var i=t=>{try{d(a.next(t))}catch(e){o(e)}},r=t=>{try{d(a.throw(t))}catch(e){o(e)}},d=t=>t.done?n(t.value):Promise.resolve(t.value).then(i,r);d((a=a.apply(t,e)).next())});import{m as u,q as l,r as _,w as m,n as y,b as v,d as p,x as D,T as f,u as w,y as g,t as h,z as b}from"./firebase-vendor-Xl_GeJX1.js";import{d as q}from"./index-CKK7GlfE.js";import"./ui-vendor-xs3J0kw7.js";import"./react-vendor-BVrHFBWf.js";import"./capacitor-vendor-Be0kW8mJ.js";import"./router-vendor-DDng8bu2.js";import"./utils-vendor-DglL0U6P.js";const j=new Map;function x(t,e){return c(this,null,function*(){var a,n;const o=`items-${t||"all"}-${(null==e?void 0:e.id)||"start"}`,i=j.get(o);if(i&&(r=i.timestamp,Date.now()-r<12e4))return i.data;var r;const c=u(q,"items");let D=l(c,m("is_archived","!=",!0),_("name"));t&&(D=l(D,h(t))),e&&(D=l(D,b(e)));const f=yield y(D),w=[];for(const t of f.docs){const e=t.data(),o=s(d({id:t.id},e),{created_at:(null==(a=e.created_at)?void 0:a.toDate)?e.created_at.toDate():new Date(e.created_at||Date.now()),updated_at:(null==(n=e.updated_at)?void 0:n.toDate)?e.updated_at.toDate():new Date(e.updated_at||Date.now())});if(o.category_id){const t=yield v(p(q,"categories",o.category_id));t.exists()&&(o.category=d({id:t.id},t.data()))}const i=yield k(o.id);i&&(o.current_quantity=i.current_quantity,o.average_unit_cost=i.average_unit_cost,o.last_transaction_date=i.last_transaction_date,o.total_value=i.total_value),w.push(o)}const g={items:w,lastDoc:f.docs[f.docs.length-1]};return j.set(o,{data:g,timestamp:Date.now()}),g})}function O(t){return c(this,null,function*(){var e,a;const n=u(q,"items"),o=l(n,m("category_id","==",t),m("is_archived","!=",!0),_("name")),i=yield y(o),r=[];for(const t of i.docs){const n=t.data(),o=s(d({id:t.id},n),{created_at:(null==(e=n.created_at)?void 0:e.toDate)?n.created_at.toDate():new Date(n.created_at||Date.now()),updated_at:(null==(a=n.updated_at)?void 0:a.toDate)?n.updated_at.toDate():new Date(n.updated_at||Date.now())}),i=yield k(o.id);i&&(o.current_quantity=i.current_quantity,o.average_unit_cost=i.average_unit_cost,o.last_transaction_date=i.last_transaction_date,o.total_value=i.total_value),r.push(o)}return r})}function P(t){return c(this,null,function*(){var e,a;const n=p(q,"items",t),o=yield v(n);if(!o.exists())throw new Error("Item not found");const i=o.data(),r=s(d({id:o.id},i),{created_at:(null==(e=i.created_at)?void 0:e.toDate)?i.created_at.toDate():new Date(i.created_at||Date.now()),updated_at:(null==(a=i.updated_at)?void 0:a.toDate)?i.updated_at.toDate():new Date(i.updated_at||Date.now())});if(r.category_id){const t=yield v(p(q,"categories",r.category_id));t.exists()&&(r.category=d({id:t.id},t.data()))}const c=yield k(r.id);return c&&(r.current_quantity=c.current_quantity,r.average_unit_cost=c.average_unit_cost,r.last_transaction_date=c.last_transaction_date,r.total_value=c.total_value),r})}function E(t){return c(this,null,function*(){const e=u(q,"items"),a=l(e,m("category_id","==",t.category_id),m("name","==",t.name.trim()));if(!(yield y(a)).empty)throw new Error("An item with this name already exists in this category");return P((yield D(u(q,"items"),s(d({},t),{name:t.name.trim(),unit_price:t.unit_price||0,barcode:t.barcode||null,sku:t.sku||null,supplier:t.supplier||null,location:t.location||null,reorder_point:t.reorder_point||10,is_archived:!1,created_at:f.fromDate(new Date),updated_at:f.fromDate(new Date)}))).id)})}function C(t,e){return c(this,null,function*(){var a;if(e.name||e.category_id){const n=yield P(t),o=(null==(a=e.name)?void 0:a.trim())||n.name,i=e.category_id||n.category_id,r=u(q,"items"),d=l(r,m("category_id","==",i),m("name","==",o));if((yield y(d)).docs.some(e=>e.id!==t))throw new Error("An item with this name already exists in this category")}const n=p(q,"items",t),o=s(d(d({},e),e.name&&{name:e.name.trim()}),{updated_at:f.fromDate(new Date)});return yield w(n,o),P(t)})}function L(t){return c(this,null,function*(){const e=u(q,"transactions"),a=l(e,m("item_id","==",t));if(!(yield y(a)).empty){const e=p(q,"items",t);return void(yield w(e,{is_archived:!0,updated_at:f.fromDate(new Date)}))}yield g(p(q,"items",t))})}function k(t){return c(this,null,function*(){const e=u(q,"transactions"),a=l(e,m("item_id","==",t)),n=yield y(a);if(n.empty)return{item_id:t,current_quantity:0,average_unit_cost:0,last_transaction_date:new Date,total_value:0};let o=0,i=0,r=0,d=new Date(0);n.docs.sort((t,e)=>{var a,n,o,i;const r=(null==(a=t.data().transaction_date)?void 0:a.toDate)?null==(n=t.data().transaction_date)?void 0:n.toDate():new Date(t.data().transaction_date);return((null==(o=e.data().transaction_date)?void 0:o.toDate)?null==(i=e.data().transaction_date)?void 0:i.toDate():new Date(e.data().transaction_date)).getTime()-r.getTime()}).forEach(t=>{var e;const a=t.data(),n=(null==(e=a.transaction_date)?void 0:e.toDate)?a.transaction_date.toDate():new Date(a.transaction_date||Date.now());n>d&&(d=n),"stock_in"===a.type?(o+=a.quantity,i+=a.total_value,r+=a.quantity):o-=a.quantity});const s=r>0?i/r:0,c=o*s;return{item_id:t,current_quantity:Math.max(0,o),average_unit_cost:s,last_transaction_date:d,total_value:c}})}function T(t,e){return c(this,null,function*(){var a,n,o;const i=u(q,"items");let r=l(i,m("is_archived","!=",!0),_("name"));e&&(r=l(i,m("category_id","==",e),m("is_archived","!=",!0),_("name")));const c=yield y(r),D=[];for(const e of c.docs){const i=e.data(),r=s(d({id:e.id},i),{created_at:(null==(a=i.created_at)?void 0:a.toDate)?i.created_at.toDate():new Date(i.created_at||Date.now()),updated_at:(null==(n=i.updated_at)?void 0:n.toDate)?i.updated_at.toDate():new Date(i.updated_at||Date.now())});if(t&&!r.name.toLowerCase().includes(t.toLowerCase())&&!(null==(o=r.description)?void 0:o.toLowerCase().includes(t.toLowerCase())))continue;if(r.category_id){const t=yield v(p(q,"categories",r.category_id));t.exists()&&(r.category=d({id:t.id},t.data()))}const c=yield k(r.id);c&&(r.current_quantity=c.current_quantity,r.average_unit_cost=c.average_unit_cost,r.last_transaction_date=c.last_transaction_date,r.total_value=c.total_value),D.push(r)}return D})}export{E as createItem,L as deleteItem,P as getItem,k as getItemStockLevel,x as getItems,O as getItemsByCategory,T as searchItems,C as updateItem};
